#!/bin/sh

# disable USB RS9113 module for now, just use SDIO RS9113 module. 
# onebox-pwr.sh off

modprobe cfg80211

modprobe onebox_common_gpl

modprobe wlan
modprobe wlan_wep
modprobe wlan_tkip
modprobe wlan_ccmp
modprobe wlan_aes_cmac
modprobe wlan_acl
modprobe wlan_xauth
modprobe wlan_scan_sta
modprobe onebox_wlan_nongpl
modprobe onebox_wlan_gpl

#Power_mode type
# 0 - HIGH  POWER MODE
# 1 - MEDIUM POWER MODE
# 2 - LOW POWER MODE
BT_RF_TX_POWER_MODE=0
BT_RF_RX_POWER_MODE=0

PARAMS=$PARAMS" bt_rf_tx_power_mode=$BT_RF_TX_POWER_MODE"
PARAMS=$PARAMS" bt_rf_rx_power_mode=$BT_RF_RX_POWER_MODE"

modprobe onebox_bt_nongpl $PARAMS
modprobe onebox_bt_gpl

cat /dev/null > /var/log/messages
#dmesg -c > /dev/null
#sh dump_msg.sh &
#dmesg -n 7


#Driver Mode 1 END-TO-END mode,
#            2 RF Evaluation Mode

DRIVER_MODE=1

# COEX MODE:
#							1    WLAN STATION /WIFI-Direct/WLAN PER
#							2    WLAN ACCESS POINT(including muliple APs on different vaps)
#							3    WLAN ACCESS POINT + STATION MODE(on multiple vaps)

#							4    BT CLASSIC MODE/BT CLASSIC PER MODE
#							5    WLAN STATION + BT CLASSIC MODE
#							6    WLAN ACCESS POINT + BT CLASSIC MODE
#							8    BT LE MODE /BT LE PER MODE
#							9    WLAN STATION + BT LE MODE
#							12   BT CLASSIC + BT LE MODE
#							13   WLAN STATION + BT CLASSIC MODE + BT LE MODE
#							14   WLAN ACCESS POINT + BT CLASSIC MODE+ BT LE MODE

#							16   ZIGBEE MODE/ ZIGBEE PER MODE
#							17   WLAN STATION + ZIGBEE
#							32   ZIGBEE COORDINATOR MODE
#                           				48   ZIGBEE ROUTER MODE

COEX_MODE=14

#To enable TA-level SDIO aggregation set 1 else set 0 to disable it.
TA_AGGR=3

#Disable Firmware load set 1 to skip FW loading through Driver else set to 0.
SKIP_FW_LOAD=0

#FW Download Mode
#	1 - Full Flash mode with Secondary Boot Loader
#	2 - Full RAM mode with Secondary Boot Loader
#	3 - Flash + RAM mode with Secondary Boot Loader
#	4 - Firmware loading WITHOUT Secondary Boot Loader
#	5 - Firmware loading WITHOUT Secondary Boot Loader with Scatters
# Recommended to use the default mode 1
#FW_LOAD_MODE=5
FW_LOAD_MODE=1


#ulp_ps_handshake_mode
#  0 - No hand shake Mode
#  1 - GPIO Hand shake Mode
#  2 - Packet hand shake Mode
###########Default is Packet handshake mode=2
ULP_HANDSHAKE_MODE=2

#lp_ps_handshake_mode
#   0 - No hand shake Mode
#   1 - GPIO Hand shake Mode
###########Default is No hand shake mode=0
LP_HANDSHAKE_MODE=0

#SDIO Clock speed
#SDIO_CLOCK_SPEED=25000
SDIO_CLOCK_SPEED=50000

#Antenna diversity enable
RSI_ANTENNA_DIVERSITY=0

#Antenna Selection
ANT_SEL_VAL=2	# 2 Internal Antenna Selection
		# 3 External Antenna Selection

####RF_POWER_MODE Selection

# 0x00 For Both TX and RX High Power
# 0x11 For Both TX and RX Medium Power
# 0x22 For Both TX and RX LOW Power

# 0x10 For High Power TX and Medium RX Power
# 0x20 For High Power TX and LOW RX Power

# 0x01 For Medium TX and RX High Power
# 0x21 For Medium Power TX and LOW RX Power

# 0x02 For Low Power TX and RX High Power
# 0x12 For LOW Power TX and Medium RX Power


WLAN_RF_PWR_MODE=0x00
BT_RF_PWR_MODE=0x00
ZIGB_RF_PWR_MODE=0x00

#ONBOARD ANT SELECTION
# 1 Module is having inbuit antenna
# 0 EXt Antenna
ONBOARD_ANT_SEL=1

#RETRY_COUNT value (valid range is 7 to 15)
SET_RETRY_COUNT=15

#COUNTRY Selection
# 0 World Domain
# 840 US Domain Maps to US Region
# 276 Germany Maps to EU Region
# 392 Japan Maps to Japan Region
SET_COUNTRY_CODE=0

SET_BT_FEATURE_BITMAP=0x00

UART_DEBUG=0x0

#Enter the distance of the PEER in meters
#This is to configure ACK and SLOT related timeout values.
CONFIG_PEER_DISTANCE=0

PARAMS=" driver_mode=$DRIVER_MODE"
PARAMS=$PARAMS" firmware_path=/lib/firmware/rs9113/"
PARAMS=$PARAMS" onebox_zone_enabled=0x1"
PARAMS=$PARAMS" ta_aggr=$TA_AGGR"
PARAMS=$PARAMS" skip_fw_load=$SKIP_FW_LOAD"
PARAMS=$PARAMS" fw_load_mode=$FW_LOAD_MODE"
PARAMS=$PARAMS" sdio_clock=$SDIO_CLOCK_SPEED"
PARAMS=$PARAMS" enable_antenna_diversity=$RSI_ANTENNA_DIVERSITY"
PARAMS=$PARAMS" coex_mode=$COEX_MODE"
PARAMS=$PARAMS" lp_ps_handshake_mode=$LP_HANDSHAKE_MODE"
PARAMS=$PARAMS" ulp_ps_handshake_mode=$ULP_HANDSHAKE_MODE"
PARAMS=$PARAMS" obm_ant_sel_val=$ANT_SEL_VAL"
PARAMS=$PARAMS" user_onboard_ant_val=$ONBOARD_ANT_SEL"
PARAMS=$PARAMS" wlan_rf_power_mode=$WLAN_RF_PWR_MODE"
PARAMS=$PARAMS" bt_rf_power_mode=$BT_RF_PWR_MODE"
PARAMS=$PARAMS" zigb_rf_power_mode=$ZIGB_RF_PWR_MODE"
PARAMS=$PARAMS" country_code=$SET_COUNTRY_CODE"
PARAMS=$PARAMS" retry_count=$SET_RETRY_COUNT"
PARAMS=$PARAMS" bt_feature_bitmap=$SET_BT_FEATURE_BITMAP"
PARAMS=$PARAMS" uart_debug=$UART_DEBUG"
PARAMS=$PARAMS" peer_dist=$CONFIG_PEER_DISTANCE"

#modprobe common_nongpl.ko $PARAMS
modprobe onebox_nongpl $PARAMS
#modprobe onebox_nongpl.ko
modprobe onebox_gpl

WLAN_BT=3
onebox-util rpine0 enable_protocol $WLAN_BT
onebox-util rpine0 create_vap wifi0 ap
onebox-util rpine0 create_vap wifi1 mon
ifconfig wifi0 up
ifconfig wifi1 up

exit 0

onebox-util rpine1 enable_protocol $WLAN_BT
onebox-util rpine1 create_vap wifi2 ap
onebox-util rpine1 create_vap wifi3 mon
ifconfig wifi2 up
ifconfig wifi3 up

exit 0
